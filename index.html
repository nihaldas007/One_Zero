<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enrollment Management System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9; /* Light background */
        }
        /* Custom scrollbar for table container */
        .scroll-x::-webkit-scrollbar {
            height: 8px;
        }
        .scroll-x::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .view-panel {
            min-height: 70vh; /* Ensure views fill space */
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="flex flex-col min-h-screen">
        <!-- Header/Navigation Bar -->
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-indigo-700">
                    Dining System
                </h1>
                <div id="header-actions" class="flex items-center space-x-4">
                    <span id="current-panel-label" class="text-gray-600 hidden sm:inline font-semibold"></span>
                    
                    <!-- Manager/Admin Login Button (Visible when unauthenticated) -->
                    <button id="manager-login-btn" onclick="showManagerLogin()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                        Admin or Manager Login
                    </button>

                    <!-- Logout Button (Visible when authenticated) -->
                    <button id="logout-btn" onclick="handleLogout()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md hidden">
                        Logout
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

            <!-- 1. PUBLIC FACING VIEW (Default View: Enrollment/Login Tabs) -->
            <div id="public-view" class="view-panel hidden justify-center">
                <div class="w-full max-w-2xl mx-auto">
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-4 text-center">
                        Public Access Portal
                    </h2>
                    <!-- Tab Switcher -->
                    <div class="flex justify-center border-b border-gray-200 mb-6 bg-white p-1 rounded-xl shadow-inner">
                        <button id="tab-enrollment" onclick="setPublicView('enrollment')" class="flex-1 px-6 py-3 text-lg font-medium rounded-lg transition duration-200 text-gray-700">
                            New Enrollment
                        </button>
                        <button id="tab-member-login" onclick="setPublicView('memberLogin')" class="flex-1 px-6 py-3 text-lg font-medium rounded-lg transition duration-200 text-gray-500">
                            Member Login
                        </button>
                    </div>

                    <!-- Enrollment Form Content (Combined Student/Manager) -->
                    <div id="enrollment-content" class="p-6 bg-white rounded-xl shadow-lg">
                        <!-- Content injected by JS -->
                    </div>

                    <!-- Member Login Form Content (Combined Student/Manager) -->
                    <div id="member-login-content" class="p-6 bg-white rounded-xl shadow-lg hidden">
                        <!-- Content injected by JS -->
                    </div>
                </div>
            </div>

            <!-- 2. MANAGER/ADMIN LOGIN VIEW (Protected by Credentials) -->
            <div id="manager-login-view" class="view-panel hidden flex items-center justify-center">
                <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">
                        Admin / Manager Login
                    </h2>
                    <p class="text-center text-sm text-gray-500 mb-2 font-semibold">Admin: admin@org.com (Password: admin123)</p>
                    <p class="text-center text-sm text-gray-500 mb-6 font-semibold">Manager: manager@org.com (Password: manager123)</p>
                    <form id="manager-login-form" class="space-y-6">
                        <div>
                            <label for="login-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" id="login-email" name="email" required placeholder="Enter your email" value="manager@org.com"
                                class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="login-password" name="password" required placeholder="Enter your password" value="manager123"
                                class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-lg transform hover:scale-[1.01]">
                            Login
                        </button>
                    </form>
                    <button onclick="updateView()" class="mt-4 w-full text-sm text-gray-600 hover:text-indigo-600 transition duration-150">
                        &#8592; Back to Public Portal
                    </button>
                </div>
            </div>
            
            <!-- 3. MAIN ADMIN PANEL VIEW (Protected) -->
            <div id="admin-view" class="view-panel hidden">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2">
                    Main Admin Dashboard
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Add Manager Form -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-purple-500">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Add New Manager</h3>
                        <p class="text-sm text-gray-500 mb-4">This bypasses the public enrollment queue.</p>
                        <form id="admin-add-manager-form" class="space-y-4">
                            <div><label for="admin-direct-name-manager" class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" id="admin-direct-name-manager" name="name" required placeholder="Jane Smith" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-purple-500 focus:border-purple-500"></div>
                            <div><label for="admin-direct-email-manager" class="block text-sm font-medium text-gray-700">Email Address</label><input type="email" id="admin-direct-email-manager" name="email" required placeholder="manager.new@example.com" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-purple-500 focus:border-purple-500"></div>
                            <div><label for="admin-direct-password-manager" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="admin-direct-password-manager" name="password" required placeholder="Min 6 characters" minlength="6" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-purple-500 focus:border-purple-500"></div>
                            <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-md">
                                Create Manager Account
                            </button>
                        </form>
                    </div>

                     <!-- Add Student Form -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Add New Student</h3>
                        <p class="text-sm text-gray-500 mb-4">This bypasses the public enrollment queue.</p>
                        <form id="admin-add-student-form" class="space-y-4">
                            <div><label for="admin-direct-name-student" class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" id="admin-direct-name-student" name="name" required placeholder="John Doe" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label for="admin-direct-email-student" class="block text-sm font-medium text-gray-700">Email Address</label><input type="email" id="admin-direct-email-student" name="email" required placeholder="john.doe@example.com" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <div><label for="admin-direct-password-student" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="admin-direct-password-student" name="password" required placeholder="Min 6 characters" minlength="6" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"></div>
                            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-md">
                                Create Student Account
                            </button>
                        </form>
                    </div>
                </div>
                
                <h3 class="text-2xl font-bold text-gray-900 mt-10 mb-4 border-b pb-2">All System Users</h3>
                <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto scroll-x">
                    <div class="min-w-[700px]">
                         <!-- Table for all users (Admin/Manager/Student, Approved/Denied) - populated by JS -->
                        <table class="w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name (Email)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="admin-users-table-body">
                                <!-- Users populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 4. MANAGER PANEL VIEW (Protected) -->
            <div id="manager-view" class="view-panel hidden">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2">
                    Manager Panel: Review & Approvals
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Manager Add Student Form Button -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500 col-span-1 md:col-span-3">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Student Management</h3>
                        <p class="text-sm text-gray-500 mb-4">Quickly add a student account directly, bypassing the public queue.</p>
                        <button onclick="openAddStudentModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                            + Add New Student Directly
                        </button>
                    </div>
                </div>

                <h3 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">Public Enrollment Requests</h3>

                <!-- Enrollment Requests Table (Responsive) -->
                <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto scroll-x">
                    <div class="min-w-[700px]">
                        <table class="w-full divide-y divide-gray-200" id="requests-table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Member Name (Email)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Applied</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="requests-table-body">
                                <!-- Rows populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 5. STUDENT DASHBOARD VIEW (Protected) -->
            <div id="student-dashboard-view" class="view-panel hidden flex items-start justify-center">
                <div class="w-full max-w-4xl">
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2">
                        Student Dashboard
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500 space-y-3">
                            <p class="text-sm font-medium text-gray-500">Welcome</p>
                            <p class="text-3xl font-bold text-gray-900" id="dashboard-student-name">Loading...</p>
                            <p class="text-gray-600">Email: <span id="dashboard-student-email" class="font-medium"></span></p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500 space-y-3">
                            <p class="text-sm font-medium text-gray-500">Membership Status</p>
                            <p class="text-3xl font-bold text-gray-900" id="dashboard-status-text">APPROVED</p>
                            <p class="text-sm text-gray-500">You now have full access to our resources.</p>
                        </div>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Resources</h3>
                        <p class="text-gray-600">Since your account is approved, you can access the members-only resources area here.</p>
                    </div>
                </div>
            </div>


             <!-- Confirmation Modal (For Manager/Admin Approvals) -->
            <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform transition-all">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Confirm Action</h3>
                    <p class="text-gray-600 mb-6" id="modal-message">
                        Are you sure you want to [action] the enrollment request for [name]?
                    </p>
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeModal('confirmation-modal')" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-150">
                            Cancel
                        </button>
                        <button id="modal-confirm-btn" class="px-4 py-2 text-white font-medium rounded-lg transition duration-150">
                            Confirm
                        </button>
                    </div>
                </div>
            </div>

            <!-- Add Student Modal (For Manager/Admin Direct Creation) -->
            <div id="add-student-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md transform transition-all">
                    <h3 class="text-xl font-bold text-gray-800 mb-4" id="add-student-title">Add New Student</h3>
                    <p class="text-gray-600 mb-6">Create an approved student account directly.</p>
                    <form id="direct-add-student-form" class="space-y-4">
                        <div>
                            <label for="direct-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="direct-name" name="name" required placeholder="John Doe" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="direct-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" id="direct-email" name="email" required placeholder="john.doe@example.com" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="direct-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="direct-password" name="password" required placeholder="Min 6 characters" minlength="6" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal('add-student-modal')" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-150">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition duration-150">
                                Create Student
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Add Manager Modal (Admin Direct Creation) -->
            <div id="add-manager-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
                <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md transform transition-all">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Add New Manager</h3>
                    <p class="text-gray-600 mb-6">Create an approved manager account directly.</p>
                    <form id="direct-add-manager-form" class="space-y-4">
                        <div>
                            <label for="manager-direct-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                            <input type="text" id="manager-direct-name" name="name" required placeholder="Jane Smith" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-purple-500 focus:border-purple-500">
                        </div>
                        <div>
                            <label for="manager-direct-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                            <input type="email" id="manager-direct-email" name="email" required placeholder="manager.new@example.com" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-purple-500 focus:border-purple-500">
                        </div>
                        <div>
                            <label for="manager-direct-password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="manager-direct-password" name="password" required placeholder="Min 6 characters" minlength="6" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-purple-500 focus:border-purple-500">
                        </div>
                        <div class="flex justify-end space-x-3 pt-4">
                            <button type="button" onclick="closeModal('add-manager-modal')" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition duration-150">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition duration-150">
                                Create Manager
                            </button>
                        </div>
                    </form>
                </div>
            </div>


            <!-- Message Box for Confirmation -->
            <div id="message-box" class="fixed bottom-4 right-4 text-white p-4 rounded-lg shadow-xl hidden transition-opacity duration-300">
                Action successful!
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white mt-auto">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center text-sm">
                &copy; 2025 New Member Enrollment System.
            </div>
        </footer>
    </div>

    <!-- JavaScript for dynamic behavior and the Admin/Manager/Student System logic -->
    <script>
        // --- Hardcoded Data ---
        const SYSTEM_USERS = { 
            // Admin role added
            'admin@org.com': { password: 'admin123', role: 'Admin' }, 
            // Manager credentials updated
            'manager@org.com': { password: 'manager123', role: 'Manager' } 
        };
        
        // Simulating the database of enrollment requests/user accounts
        let requests = [
            // Student: Pending - needs manager action
            { id: 101, name: "Alice Johnson", email: "alice@test.com", type: "Student", date: "2025-11-20", status: "Pending", password: "password101" },
            // Manager: Direct Admin Creation (Approved)
            { id: 102, name: "Bob Williams", email: "bob@test.com", type: "Manager", date: "2025-11-19", status: "Approved", password: "password102" },
            // Student: Approved - can login
            { id: 103, name: "Charlie Davis", email: "charlie@test.com", type: "Student", date: "2025-11-19", status: "Approved", password: "password103" },
            // Student: Denied
            { id: 105, name: "Eve Brown", email: "eve@test.com", type: "Student", date: "2025-11-17", status: "Denied", password: "password105" },
            // Manager: NEW PENDING MANAGER REQUEST (for testing admin-only approval)
            { id: 106, name: "David Green", email: "david@test.com", type: "Manager", date: "2025-11-21", status: "Pending", password: "password106" },
        ];
        
        // --- Template Strings for Public View (Combined Enrollment) ---
        const enrollmentContentTemplate = `
            <h3 class="text-xl font-bold text-gray-800 mb-4">Register for Membership</h3>
            <form id="enrollment-form" class="space-y-4">
                <div>
                    <label for="enrollment-type" class="block text-sm font-medium text-gray-700">Member Type</label>
                    <select id="enrollment-type" name="type" required 
                            class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Student">Student</option>
                        <option value="Manager">Manager</option>
                    </select>
                </div>
                <div><label for="student-name" class="block text-sm font-medium text-gray-700">Full Name</label><input type="text" id="student-name" name="name" required placeholder="John Doe" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div><label for="student-email-reg" class="block text-sm font-medium text-gray-700">Email Address</label><input type="email" id="student-email-reg" name="email" required placeholder="john.doe@example.com" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div><label for="student-password-reg" class="block text-sm font-medium text-gray-700">Create Password</label><input type="password" id="student-password-reg" name="password" required placeholder="Minimum 6 characters" minlength="6" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"></div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-lg transform hover:scale-[1.01]">Submit Enrollment Request</button>
            </form>
            <div class="mt-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Latest Request Status</h3>
                <div id="latest-status" class="p-4 border-2 border-gray-200 rounded-lg">
                    <p class="text-gray-600 mb-2">Status for latest request:</p>
                    <div id="latest-status-text" class="text-xl font-bold text-gray-500">No request submitted yet.</div>
                </div>
            </div>
        `;
        
        // --- Template Strings for Public View (Combined Member Login) ---
        const memberLoginContentTemplate = `
            <h3 class="text-xl font-bold text-gray-800 mb-4">Login to Dashboard</h3>
            <p class="text-sm text-gray-500 mb-4">Log in after your enrollment request has been approved.</p>
            <form id="member-login-form" class="space-y-4">
                 <div>
                    <label for="member-login-type" class="block text-sm font-medium text-gray-700">Member Type</label>
                    <select id="member-login-type" name="type" required 
                            class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Student">Student</option>
                        <option value="Manager">Manager</option>
                    </select>
                </div>
                <div><label for="member-login-email" class="block text-sm font-medium text-gray-700">Email Address</label><input type="email" id="member-login-email" name="email" required placeholder="Enter your registered email" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"></div>
                <div><label for="member-login-password" class="block text-sm font-medium text-gray-700">Password</label><input type="password" id="member-login-password" name="password" required placeholder="Enter your password" class="mt-1 block w-full border border-gray-300 rounded-lg shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"></div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-lg transform hover:scale-[1.01]">Log In</button>
            </form>
            <p class="text-center text-xs text-gray-500 mt-6">
                Test Student Login: <span class="font-semibold text-green-600">charlie@test.com / password103</span>
            </p>
        `;

        // --- DOM Elements ---
        const publicView = document.getElementById('public-view');
        const managerLoginView = document.getElementById('manager-login-view');
        const adminView = document.getElementById('admin-view'); 
        const managerView = document.getElementById('manager-view');
        const studentDashboardView = document.getElementById('student-dashboard-view');
        const enrollmentContent = document.getElementById('enrollment-content');
        const memberLoginContent = document.getElementById('member-login-content'); 
        const managerLoginForm = document.getElementById('manager-login-form');
        const requestsTableBody = document.getElementById('requests-table-body');
        const adminUsersTableBody = document.getElementById('admin-users-table-body');
        const managerLoginBtn = document.getElementById('manager-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const currentPanelLabel = document.getElementById('current-panel-label');
        const modal = document.getElementById('confirmation-modal');
        const addStudentModal = document.getElementById('add-student-modal');
        const addManagerModal = document.getElementById('add-manager-modal');
        const messageBox = document.getElementById('message-box');
        
        // Direct creation forms
        const adminAddManagerForm = document.getElementById('admin-add-manager-form');
        const adminAddStudentForm = document.getElementById('admin-add-student-form');
        const directAddStudentForm = document.getElementById('direct-add-student-form');


        // --- State Management ---
        let isAuthenticated = false;
        let userRole = null; // 'Admin', 'Manager', or 'Student'
        let loggedInUser = null; // Stores the object of the successfully logged-in user
        let latestStudentRequest = null; // Tracks the *last submitted* enrollment request
        let currentPublicView = 'enrollment'; // 'enrollment' or 'memberLogin'
        
        // --- Core View Control ---
        
        /**
         * Switches the main view based on the current user state.
         */
        function updateView() {
            // Hide all panels
            managerLoginView.classList.add('hidden', 'flex');
            adminView.classList.add('hidden');
            managerView.classList.add('hidden');
            publicView.classList.add('hidden', 'flex');
            studentDashboardView.classList.add('hidden', 'flex');
            
            // Manage header buttons/labels
            managerLoginBtn.classList.add('hidden');
            logoutBtn.classList.add('hidden');
            currentPanelLabel.classList.add('hidden');

            if (isAuthenticated) {
                logoutBtn.classList.remove('hidden');
                currentPanelLabel.classList.remove('hidden');

                if (userRole === 'Admin') {
                    adminView.classList.remove('hidden');
                    currentPanelLabel.textContent = 'Admin Panel';
                    renderAdminUsersTable();
                } else if (userRole === 'Manager') {
                    managerView.classList.remove('hidden');
                    currentPanelLabel.textContent = 'Manager Panel';
                    renderTable();
                } else if (userRole === 'Student') {
                    studentDashboardView.classList.remove('hidden');
                    studentDashboardView.classList.add('flex');
                    currentPanelLabel.textContent = 'Student Dashboard';
                    renderStudentDashboard();
                }
            } else {
                // PUBLIC VIEW (Default/Unauthenticated)
                publicView.classList.remove('hidden');
                publicView.classList.add('flex');
                managerLoginBtn.classList.remove('hidden');
                currentPanelLabel.textContent = 'Public Access';
                currentPanelLabel.classList.remove('hidden');
                setPublicView(currentPublicView, false); // Render the correct tab
            }
        }
        
        /**
         * Shows the login screen for the manager/admin.
         */
        function showManagerLogin() {
            // Hide all content and show login form
            adminView.classList.add('hidden');
            managerView.classList.add('hidden');
            publicView.classList.add('hidden');
            studentDashboardView.classList.add('hidden');
            managerLoginBtn.classList.add('hidden');
            managerLoginView.classList.remove('hidden');
            managerLoginView.classList.add('flex');
            currentPanelLabel.textContent = 'Admin/Manager Login';
        }
        
        /**
         * Switches between the enrollment form and the member login form.
         */
        function setPublicView(view, updateHistory = true) {
            const tabEnrollment = document.getElementById('tab-enrollment');
            const tabMemberLogin = document.getElementById('tab-member-login');
            currentPublicView = view;
            
            // Reset Tab Styles
            tabEnrollment.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
            tabMemberLogin.classList.remove('bg-indigo-600', 'text-white', 'shadow-md');
            tabEnrollment.classList.add('bg-white', 'text-gray-700');
            tabMemberLogin.classList.add('bg-white', 'text-gray-700');

            // Show/Hide Content and set active style
            if (view === 'enrollment') {
                enrollmentContent.classList.remove('hidden');
                memberLoginContent.classList.add('hidden');
                tabEnrollment.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
                tabEnrollment.classList.remove('bg-white', 'text-gray-700');
                renderLatestRequestStatus(); // Show current status
            } else if (view === 'memberLogin') {
                enrollmentContent.classList.add('hidden');
                memberLoginContent.classList.remove('hidden');
                tabMemberLogin.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
                tabMemberLogin.classList.remove('bg-white', 'text-gray-700');
            }
        }
        
        // --- Authentication Handlers ---
        
        /**
         * Handles the Manager/Admin login form submission (for hardcoded system users).
         */
        function handleManagerLogin(e) {
            e.preventDefault();
            const email = e.target.elements['login-email'].value.trim();
            const password = e.target.elements['login-password'].value.trim();
            
            const user = SYSTEM_USERS[email];
            
            if (user && user.password === password) {
                isAuthenticated = true;
                userRole = user.role;
                loggedInUser = { name: user.role, email: email, type: user.role }; 
                showMessageBox(`Logged in successfully as ${user.role}!`, 'green');
                updateView(); 
            } else {
                showMessageBox('Invalid email or password for Admin/Manager.', 'red');
            }
        }
        
        /**
         * Handles the Public Member Login form submission (for approved requests).
         */
        function handlePublicLogin(e) {
            e.preventDefault();
            const email = e.target.elements['member-login-email'].value.trim();
            const password = e.target.elements['member-login-password'].value;
            const role = e.target.elements['member-login-type'].value; // Get selected role

            // Find the request matching email, password, and *desired* role
            const req = requests.find(r => r.email === email && r.password === password && r.type === role);

            if (!req) {
                 showMessageBox('Login failed: Invalid credentials or role selected.', 'red');
                return;
            }
            
            if (req.status === 'Approved') {
                isAuthenticated = true;
                userRole = req.type;
                loggedInUser = req;
                showMessageBox(`Welcome, ${req.name}! Logged in successfully.`, 'green');
                updateView(); 
            } else {
                // User exists but is not approved
                showMessageBox(`Your enrollment status is: ${req.status}. Access denied until approved.`, 'orange');
            }
        }

        /**
         * Handles the logout action.
         */
        function handleLogout() {
            isAuthenticated = false;
            userRole = null;
            loggedInUser = null;
            showMessageBox('Logged out successfully.', 'green');
            updateView(); // Route back to Public View
        }

        // --- Manager Panel Logic (Approval Table) ---
        
        /**
         * Renders the table rows for Pending Enrollment Requests.
         */
        function renderTable() {
            requestsTableBody.innerHTML = ''; // Clear existing rows
            // Filter all pending requests (Student and Manager)
            const pendingRequests = requests.filter(req => req.status === 'Pending');
            
            if (pendingRequests.length === 0) {
                 requestsTableBody.innerHTML = `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No pending enrollment requests.</td></tr>`;
                 return;
            }

            pendingRequests.forEach(req => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 transition duration-150';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${req.name} (${req.email})</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-semibold">${req.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${req.date}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="openModal(${req.id}, 'Approve')" class="text-green-600 hover:text-green-900 font-medium mr-2 transform transition-transform hover:scale-105">Approve</button>
                        <button onclick="openModal(${req.id}, 'Deny')" class="text-red-600 hover:text-red-900 font-medium transform transition-transform hover:scale-105">Deny</button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                            Pending
                        </span>
                    </td>
                `;
                requestsTableBody.appendChild(row);
            });
        }
        
        // --- Admin Panel Logic (User Management Table) ---

        /**
         * Renders the table showing all users (Admin view).
         */
        function renderAdminUsersTable() {
            adminUsersTableBody.innerHTML = ''; 
            
            // Combine all users in the requests array (Admin view sees all approved, denied, and pending Manager types)
            const allUsers = requests.filter(u => u.status === 'Approved' || u.status === 'Denied' || u.type === 'Manager');

            if (allUsers.length === 0) {
                 adminUsersTableBody.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No approved users in the system.</td></tr>`;
                 return;
            }
            
            allUsers.forEach(user => {
                let statusColor = '';
                let statusText = user.status || 'Active'; // Use status if available, otherwise 'Active'
                
                if (user.status === 'Approved') {
                    statusColor = 'bg-green-100 text-green-800';
                } else if (user.status === 'Denied') {
                    statusColor = 'bg-red-100 text-red-800';
                } else if (user.status === 'Pending') {
                    statusColor = 'bg-yellow-100 text-yellow-800';
                } else {
                    statusColor = 'bg-gray-100 text-gray-800';
                }
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 transition duration-150';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${user.name} (${user.email})</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-semibold">${user.type}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                            ${statusText}
                        </span>
                    </td>
                `;
                adminUsersTableBody.appendChild(row);
            });
        }

        // --- Manager/Admin User Creation Logic ---

        function openAddStudentModal() {
            document.getElementById('add-student-title').textContent = userRole === 'Admin' ? 'Admin Add Student' : 'Manager Add Student';
            document.getElementById('direct-add-student-form').reset();
            addStudentModal.classList.remove('hidden');
            addStudentModal.classList.add('flex');
        }

        function openAddManagerModal() {
            if (userRole === 'Admin') {
                document.getElementById('direct-add-manager-form').reset();
                addManagerModal.classList.remove('hidden');
                addManagerModal.classList.add('flex');
            } else {
                showMessageBox("Only Admin can add Managers.", 'red');
            }
        }
        
        function handleDirectAddManager(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.elements[0].value.trim(); // Name is first element
            const email = form.elements[1].value.trim();
            const password = form.elements[2].value;

            if (requests.some(r => r.email === email)) {
                showMessageBox("An account with this email already exists.", 'red');
                return;
            }

            const newId = Math.max(...requests.map(r => r.id)) + 1;
            const today = new Date().toISOString().slice(0, 10);
            
            requests.push({ 
                id: newId, 
                name: name, 
                email: email, 
                type: "Manager", 
                date: today, 
                status: "Approved", 
                password: password
            });
            
            form.reset();
            closeModal('add-manager-modal');
            showMessageBox(`Manager ${name} created and approved successfully!`, 'purple');
            renderAdminUsersTable();
        }

        function handleDirectAddStudent(e) {
            e.preventDefault();
            const form = e.target;
            const name = form.elements[0].value.trim();
            const email = form.elements[1].value.trim();
            const password = form.elements[2].value;

            if (requests.some(r => r.email === email)) {
                showMessageBox("An account with this email already exists.", 'red');
                return;
            }

            const newId = Math.max(...requests.map(r => r.id)) + 1;
            const today = new Date().toISOString().slice(0, 10);
            
            requests.push({ 
                id: newId, 
                name: name, 
                email: email, 
                type: "Student", 
                date: today, 
                status: "Approved", 
                password: password
            });
            
            form.reset();
            closeModal('add-student-modal');
            showMessageBox(`Student ${name} created and approved successfully!`, 'indigo');
            
            if (userRole === 'Admin') renderAdminUsersTable();
        }


        // --- Confirmation Modal Logic ---
        let currentRequest = null;
        
        function openModal(id, action) {
            if (userRole !== 'Manager' && userRole !== 'Admin') return; 
            
            const modalMessage = document.getElementById('modal-message');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');

            currentRequest = requests.find(r => r.id === id);

            if (currentRequest) {
                // Pre-check for Manager approval restriction
                 if (currentRequest.type === 'Manager' && action === 'Approve' && userRole === 'Manager') {
                    // Close the current modal before showing the message box
                    closeModal('confirmation-modal');
                    showMessageBox("Permission Denied: Only the Main Admin can approve Manager enrollment requests.", 'red');
                    return;
                }

                modalMessage.innerHTML = `Are you sure you want to **${action.toLowerCase()}** the enrollment request for **${currentRequest.name}** (${currentRequest.type})?`;
                modalConfirmBtn.className = action === 'Approve' ? 'px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition duration-150' : 'px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition duration-150';
                modalConfirmBtn.onclick = () => confirmAction(id, action);
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            document.getElementById(modalId).classList.remove('flex');
            currentRequest = null;
        }

        function confirmAction(id, action) {
            closeModal('confirmation-modal');

            const requestIndex = requests.findIndex(r => r.id === id);
            
            if (requestIndex !== -1) {
                const requestToApprove = requests[requestIndex];

                // SECURITY CHECK: Block Manager from approving other Managers
                if (requestToApprove.type === 'Manager' && action === 'Approve' && userRole === 'Manager') {
                    showMessageBox("Error: Managers cannot approve other Manager enrollment requests.", 'red');
                    return; 
                }
                
                requests[requestIndex].status = action === 'Approve' ? 'Approved' : 'Denied';

                // Re-render the table for the manager/admin
                renderTable();
                if (userRole === 'Admin') renderAdminUsersTable();
                
                // Update latest request status on public view if affected
                if (latestStudentRequest && latestStudentRequest.id === id) {
                    latestStudentRequest.status = requests[requestIndex].status;
                    renderLatestRequestStatus(); 
                }
                
                showMessageBox(`Successfully ${action.toLowerCase()}d request for ${requests[requestIndex].name}.`, 'green');
            }
        }
        
        // --- Public Panel Logic (Enrollment & Status) ---

        /**
         * Handles the submission of the public enrollment form.
         */
        function handleEnrollment(e) {
            e.preventDefault();

            const form = e.target;
            const type = form.elements['enrollment-type'].value; // Get selected type
            const name = form.elements['student-name'].value.trim();
            const password = form.elements['student-password-reg'].value;
            const email = form.elements['student-email-reg'].value.trim();

            if (!name || !email || !type) {
                showMessageBox("Please enter all required fields.", 'red');
                return;
            }
             if (password.length < 6) {
                showMessageBox("Password must be at least 6 characters long.", 'red');
                return;
            }

            if (requests.some(r => r.email === email && r.status !== 'Denied')) {
                showMessageBox("An enrollment request with this email is already pending or approved.", 'red');
                return;
            }

            const newId = Math.max(...requests.map(r => r.id)) + 1;
            const today = new Date().toISOString().slice(0, 10);
            
            latestStudentRequest = { 
                id: newId, 
                name: name, 
                email: email, 
                type: type, 
                date: today, 
                status: "Pending",
                password: password
            };
            
            requests.push(latestStudentRequest);
            renderLatestRequestStatus();
            
            form.reset();
            showMessageBox(`Enrollment request submitted for ${type}! Please check your status here or log in after approval.`, 'green');
            
            // Switch to member login tab automatically after registration
            setPublicView('memberLogin');
            
            // If admin/manager is logged in, update their table
            if (isAuthenticated && (userRole === 'Manager' || userRole === 'Admin')) {
                showMessageBox(`A new ${type} request has been submitted!`, 'blue');
                renderTable();
            }
        }

        /**
         * Renders the status of the latest request made from the public panel.
         */
        function renderLatestRequestStatus() {
            const latestStatusText = document.getElementById('latest-status-text');
            if (!latestStudentRequest || !latestStatusText) return;

            const currentStatusReq = requests.find(r => r.id === latestStudentRequest.id);
            const status = currentStatusReq ? currentStatusReq.status : 'Pending';
            const type = currentStatusReq ? currentStatusReq.type : 'Member';

            latestStudentRequest.status = status;
            
            let statusText = '';
            let statusClasses = '';

            if (status === 'Pending') {
                statusText = `PENDING: Awaiting Review for ${type} Role`;
                statusClasses = 'text-yellow-600';
            } else if (status === 'Approved') {
                statusText = `APPROVED! You can now log in as ${type}.`;
                statusClasses = 'text-green-600';
            } else if (status === 'Denied') {
                statusText = `DENIED: Please contact support regarding your ${type} request.`;
                statusClasses = 'text-red-600';
            }
            
            latestStatusText.innerHTML = `
                <span class="${statusClasses}">${statusText}</span>
                <p class="text-sm font-normal text-gray-500 mt-1">Submitted: ${latestStudentRequest.date}</p>
            `;
            latestStatusText.className = 'text-xl font-bold';
        }
        
        // --- Protected Student Dashboard Logic ---
        
        /**
         * Renders the protected student dashboard content.
         */
        function renderStudentDashboard() {
            if (!loggedInUser || loggedInUser.type !== 'Student') return;
            
            const currentReq = requests.find(r => r.id === loggedInUser.id);
            const status = currentReq ? currentReq.status : 'Error';
            
            // Update the Dashboard content
            document.getElementById('dashboard-student-name').textContent = loggedInUser.name;
            document.getElementById('dashboard-student-email').textContent = loggedInUser.email;
            document.getElementById('dashboard-status-text').textContent = status;
            
            const statusCard = document.getElementById('dashboard-status-text').closest('.border-l-4');
            statusCard.classList.remove('border-green-500', 'border-red-500');
            
            if (status === 'Approved') {
                statusCard.classList.add('border-green-500');
            } else {
                statusCard.classList.add('border-red-500');
            }
        }


        // --- Utility Functions ---

        /**
         * Displays a temporary success/message box.
         */
        function showMessageBox(message, color = 'green') {
            let bgColor = '';
            if (color === 'green') {
                bgColor = 'bg-green-600';
            } else if (color === 'red') {
                bgColor = 'bg-red-600';
            } else if (color === 'blue') {
                bgColor = 'bg-blue-600';
            } else if (color === 'orange') {
                bgColor = 'bg-orange-500';
            } else if (color === 'purple') {
                bgColor = 'bg-purple-600'; 
            } else if (color === 'indigo') {
                bgColor = 'bg-indigo-600'; 
            }
            
            messageBox.className = `fixed bottom-4 right-4 text-white p-4 rounded-lg shadow-xl hidden transition-opacity duration-300 ${bgColor}`;
            
            messageBox.textContent = message;
            messageBox.classList.remove('hidden', 'opacity-0');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300); // Wait for fade-out transition
            }, 3000); // Message visible for 3 seconds
        }

        // --- Initialization ---
        
        // Function to initialize DOM and listeners
        function initApp() {
            // 1. Inject templates into the DOM
            enrollmentContent.innerHTML = enrollmentContentTemplate;
            memberLoginContent.innerHTML = memberLoginContentTemplate;
            
            // 2. Attach listeners AFTER injection
            const enrollmentForm = document.getElementById('enrollment-form');
            const memberLoginForm = document.getElementById('member-login-form'); 
            
            if (enrollmentForm) enrollmentForm.addEventListener('submit', handleEnrollment);
            if (memberLoginForm) memberLoginForm.addEventListener('submit', handlePublicLogin); 
            if (managerLoginForm) managerLoginForm.addEventListener('submit', handleManagerLogin);
            
            // Direct creation form handlers
            if (adminAddManagerForm) adminAddManagerForm.addEventListener('submit', handleDirectAddManager);
            if (adminAddStudentForm) adminAddStudentForm.addEventListener('submit', handleDirectAddStudent);
            if (directAddStudentForm) directAddStudentForm.addEventListener('submit', handleDirectAddStudent);


            // 3. Set initial public view
            setPublicView(currentPublicView, false);
            
            // 4. Load the main application view
            updateView();
        }

        window.onload = initApp;

    </script>

</body>
</html>